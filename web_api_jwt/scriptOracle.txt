-- Borrar la tabla si existe y volver a crearla
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE usuarios CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -942 THEN -- Error 942: Table or view does not exist
            RAISE;
        END IF;
END;
/

CREATE TABLE usuarios (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- ID autoincremental
    rut NUMBER UNIQUE NOT NULL, -- RUT único y obligatorio
    nombre VARCHAR2(100) NOT NULL, -- Nombre obligatorio
    apellido VARCHAR2(100) NOT NULL, -- Apellido obligatorio
    estado NUMBER(1) DEFAULT 1 NOT NULL, -- Estado booleano (0 o 1)
    password_hash VARCHAR2(255) NOT NULL, -- Hash de la contraseña (obligatorio)
    password_plain VARCHAR2(100) NOT NULL -- Contraseña en texto plano (NO RECOMENDADO en producción)
);

-- Borrar el procedimiento USUARIOS_PRC_SELECT_ROW_RUT si existe
BEGIN
    EXECUTE IMMEDIATE 'DROP PROCEDURE USUARIOS_PRC_SELECT_ROW_RUT';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -4043 THEN -- Error 4043: Object does not exist
            RAISE;
        END IF;
END;
/

-- Crear el procedimiento USUARIOS_PRC_SELECT_ROW_RUT
CREATE OR REPLACE PROCEDURE USUARIOS_PRC_SELECT_ROW_RUT (
    v_rut IN NUMBER,
    cursor_resultado OUT SYS_REFCURSOR
) AS
BEGIN   
    OPEN cursor_resultado FOR
        SELECT id, rut, nombre, apellido, estado, password_hash, password_plain 
        FROM usuarios
        WHERE rut = v_rut;
END;
/

-- Borrar el procedimiento USUARIOS_PRC_SELECT_ROW si existe
BEGIN
    EXECUTE IMMEDIATE 'DROP PROCEDURE USUARIOS_PRC_SELECT_ROW';
EXCEPTION
    WHEN OTHERS THEN
        IF SQLCODE != -4043 THEN -- Error 4043: Object does not exist
            RAISE;
        END IF;
END;
/

-- Crear el procedimiento USUARIOS_PRC_SELECT_ROW
CREATE OR REPLACE PROCEDURE USUARIOS_PRC_SELECT_ROW (
    v_id IN NUMBER,
    cursor_resultado OUT SYS_REFCURSOR
) AS
BEGIN   
    OPEN cursor_resultado FOR
        SELECT id, rut, nombre, apellido, estado, password_hash, password_plain 
        FROM usuarios
        WHERE id = v_id;
END;
/
